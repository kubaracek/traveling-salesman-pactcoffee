<div id="map"></div>
<script type="text/javascript">
$(document).ready(function() {
  // create a map in the "map" div, set the view to a given place and zoom
  var map = L.map('map').setView([51.505, -0.09], 10);

  // add an OpenStreetMap tile layer
  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  var marks = <%= @marks.to_json.html_safe %>;
  var routeData = <%= @route.to_json.html_safe %>;

  for(var i=0;i<routeData.length;i++){
    if(i+1 <= routeData.length - 1) {
      L.polyline([L.latLng(routeData[i]), L.latLng(routeData[i+1])], {color: 'red'}).addTo(map);
    }
  };

  var mapApiBase = 'http://maps.googleapis.com/maps/api/directions/json?';
  var origin = 'origin=' + routeData[0][0] + ',' + routeData[0][1];
  var destination = '&destination=' + routeData[7][0] + ',' + routeData[7][1];
  var waypoints = '&waypoints=';
  for(var i=1;i<7;i++){
    waypoints += routeData[i][0] +","+ routeData[i][1];
    //Do not add the semicolon to last one
    if(i<7){
      waypoints += "|";
    }
  }
  var apiUrl = mapApiBase + origin + waypoints + destination + '&sensor=false';

  jQuery.get(apiUrl, function(result) {
    if(result) {
      result.routes[0].legs.each(function(leg) {
        leg.steps.each(function(step) {
          console.log(step.polyline.points)
        });
      });
    }
  });

  for(var i=0;i<marks.length;i++){
    L.marker(marks[i]).addTo(map);
  }
});
</script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>